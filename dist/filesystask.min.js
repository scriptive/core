/*!
    fileSystask -- Javascript file System task
    Version 1.0.2
    https://khensolomon.github.io/let/filesystask
    (c) 2013-2015
*/
!function(o){"use strict";window.requestfileSystask,window.resolvefileSystask,window[o]=function(Setting,Init){function fileRequest(Obj,callback){Obj.fileUrlLocal=Obj.fileUrlLocal.replace(/[\#\?].*$/,""),fileSystask.request(function(fs,status){fs.root.getFile(Obj.fileUrlLocal,Obj.fileOption,function(fileEntry){callback(1,fileEntry)},function(e){callback(2,fs.root)})},function(e){callback(3,e)})}function fileCreator(fileSystemRoot,Obj,callback){fileSystemRoot.getFile(Obj.fileUrlLocal,Obj.fileOption,function(fileEntry){Obj.fileContent&&Obj.fileContentType?fileWriter(fileEntry,Obj,function(isFileWritten,fileWriterMsg){callback(isFileWritten,fileWriterMsg)}):fileReader(fileEntry,Obj,function(isFileRead,fileReaderMsg){callback(isFileRead,fileReaderMsg)})},function(e){callback(!1,e)})}function fileReader(fileEntry,Obj,callback){fileEntry.file(function(file){if(Obj.fileReadAs){var reader=new FileReader;reader.onloadstart=function(e){Obj.before(e)},reader.onprogress=function(e){Obj.progress(e)},reader.onabort=function(e){callback(!1,e)},reader.onerror=function(e){callback(!1,e)},reader.onload=function(e){callback(!0,this.result)},Task.ReadAs===!0?Obj.fileReadAs=Task.ReadAs[0]:Task.ReadAs.indexOf(Obj.fileReadAs)<0&&(Obj.fileReadAs=Task.ReadAs[0]),reader[Obj.fileReadAs](file)}else callback(!0,fileEntry)},function(file){callback(!1,file)})}function fileRemover(fileEntry,Obj,callback){fileEntry.remove(function(e){callback(!0,e)},function(e){callback(!1,e)})}function fileWriter(fileEntry,Obj,callback){fileEntry.createWriter(function(writer){writer.onwriteend=function(e){this.onwriteend=null,this.truncate(this.position),callback(!0,Obj.fileContent)},writer.onerror=function(){callback(!1,this)},Obj.fileContentType||(Obj.fileExtension||(Obj.fileExtension=Obj.fileUrlLocal.split(".").pop()),Task.extension[Obj.fileExtension]?Obj.fileContentType=Task.extension[Obj.fileExtension].ContentType:Obj.fileContentType=Task.extension.other.ContentType),writer.write(new Blob([Obj.fileContent],{type:Obj.fileContentType}))},function(writer){callback(!1,writer)})}function dirCreator(fileSystemRoot,folders,callback){"."!=folders[0]&&""!=folders[0]||(folders=folders.slice(1)),fileSystemRoot.getDirectory(folders[0],{create:!0},function(dirEntry){folders.length?dirCreator(dirEntry,folders.slice(1),callback):callback(!0)},function(e){callback(!1,e)})}function dirCheck(dir){var dirList=dir.split("/").slice(0,-1);return dirList.length>=1&&dirList}function f1(n,e){return"function"==typeof n?n(e):e}var fileSystask=this,OS={},Task={base:{Chrome:{RequestQuota:1073741824},Cordova:{RequestQuota:0},Other:{RequestQuota:0}},message:{RequestFileSystem:"requestFileSystem API/Method supported!",NoRequestFileSystem:"No requestFileSystem API/Method!",PleaseSeeStatus:"Please see {status}!"},Callback:{before:function(){},progress:function(){},done:function(){},fail:function(){},success:function(){}},Arguments:function(o,arg){for(var i in arg)arg.hasOwnProperty(i)&&0==i?o=Object.assign({},this.Callback,arg[i]):arg.hasOwnProperty(i)&&(o=Object.assign({},this.Callback,o,arg[i]));return o},ReadAs:["readAsText","readAsArrayBuffer","readAsBinaryString","readAsDataURL"],extension:{mp3:{ContentType:"audio/mp3"},mp4:{ContentType:"audio/mp4"},txt:{ContentType:"text/plain"},css:{ContentType:"text/css"},avi:{ContentType:"video/x-msvideo"},html:{ContentType:"text/html"},mxml:{ContentType:"application/xv+xml"},rss:{ContentType:"application/rss+xml"},xml:{ContentType:"application/xml"},js:{ContentType:"application/javascript"},json:{ContentType:"application/json"},xhtml:{ContentType:"application/xhtml+xml"},pdf:{ContentType:"application/pdf"},jpg:{ContentType:"image/jpeg"},jpeg:{ContentType:"image/jpeg"},png:{ContentType:"image/png"},other:{ContentType:"text/plain",Charset:"UTF-8",fileName:"Uknown",fileExtension:""}},Assigns:function(i){var defaultName=Object.keys(this.base).pop();i?"object"==typeof i?i.Base&&this.base.hasOwnProperty(i.Base)?Object.assign(OS,this.base[i.Base],i):Object.assign(OS,this.base[defaultName],i,{Base:defaultName}):"string"==typeof i&&this.base[i]?Object.assign(OS,this.base[i],{Base:i}):Object.assign(OS,this.base[defaultName],{Base:defaultName}):Object.assign(OS,this.base[defaultName],{Base:defaultName}),new Promise(function(resolve,reject){Task.Initiate[OS.Base](function(e){OS.Ok=!0,OS.message=Task.message.RequestFileSystem,resolve(e)},function(e){OS.Ok=!1,"string"==typeof e?OS.message=e:e.message?(OS.message=e.message,e.name&&(OS.name=e.name)):(OS.status=e,OS.message=Task.message.PleaseSeeStatus),reject(OS)})}).then(function(e){f1(Init.success,e)},function(e){f1(Init.fail,e)}).then(function(){fileSystask.support=OS.Ok,f1(Init.done,OS)})},Initiate:{Chrome:function(done,error){try{navigator.webkitPersistentStorage.requestQuota(OS.RequestQuota,function(grantedBytes){OS.ResponseQuota=grantedBytes,window.requestfileSystask=window.webkitRequestFileSystem,window.resolvefileSystask=window.webkitResolveLocalFileSystemURL,window.requestfileSystask(OS.Permission>0?window.PERSISTENT:window.TEMPORARY,grantedBytes,function(fileSystem){OS.Root=fileSystem.root.toURL(),done(fileSystem)},function(e){error(e)})},function(e){error(e)})}catch(e){error(e)}finally{}},Cordova:function(done,error){try{window.requestfileSystask=window.requestFileSystem||window.webkitRequestFileSystem,window.resolvefileSystask=window.resolveLocalFileSystemURL||window.webkitResolveLocalFileSystemURL,window.requestfileSystask?(window.LocalFileSystem?(window.PERSISTENT=window.LocalFileSystem.PERSISTENT,window.TEMPORARY=window.LocalFileSystem.TEMPORARY):window.cordova&&"file:"===location.protocol,window.requestfileSystask(OS.Permission>0?window.PERSISTENT:window.TEMPORARY,OS.RequestQuota,function(fileSystem){OS.Root=fileSystem.root.toURL(),done(fileSystem)},function(e){error(e)})):error(Task.message.NoRequestFileSystem)}catch(e){error(e)}finally{}},Other:function(done,error){try{window.requestfileSystask=window.requestFileSystem||window.webkitRequestFileSystem,window.resolvefileSystask=window.resolveLocalFileSystemURL||window.webkitResolveLocalFileSystemURL,window.requestfileSystask(OS.Permission>0?window.PERSISTENT:window.TEMPORARY,OS.RequestQuota,function(fileSystem){OS.Root=fileSystem.root.toURL(),done(fileSystem)},function(e){error(e)})}catch(e){navigator.webkitPersistentStorage?this.Chrome(done,error):error(e)}finally{}}},Request:{Chrome:function(done,error){try{navigator.webkitPersistentStorage.requestQuota(OS.RequestQuota,function(grantedBytes){OS.ResponseQuota=grantedBytes,window.requestfileSystask(OS.Permission>0?window.PERSISTENT:window.TEMPORARY,grantedBytes,function(fileSystem){OS.Root=fileSystem.root.toURL(),done(fileSystem)},function(e){error(e)})},function(e){error(e)})}catch(e){error(e)}finally{return window.requestfileSystask}},Cordova:function(done,error){try{window.requestfileSystask?window.requestfileSystask(OS.Permission>0?window.PERSISTENT:window.TEMPORARY,OS.RequestQuota,function(fileSystem){done(fileSystem)},function(e){error(e)}):error(Task.message.NoRequestFileSystem)}catch(e){error(e)}finally{return window.requestfileSystask}},Other:function(done,error){try{window.requestfileSystask?window.requestfileSystask(OS.Permission>0?window.PERSISTENT:window.TEMPORARY,OS.RequestQuota,function(fileSystem){done(fileSystem)},function(e){error(e)}):error(Task.message.NoRequestFileSystem)}catch(e){error(e)}finally{return window.requestfileSystask}}},Resolve:{Chrome:function(url,done,error){try{navigator.webkitPersistentStorage.requestQuota(OS.RequestQuota,function(grantedBytes){OS.ResponseQuota=grantedBytes,window.resolvefileSystask(url,done,error)},function(e){error(e)})}catch(e){error(e)}finally{return window.resolvefileSystask}},Cordova:function(url,done,error){try{window.resolvefileSystask(url,done,error)}catch(e){error(e)}finally{return window.resolvefileSystask}},Other:function(url,done,error){try{window.resolvefileSystask(url,done,error)}catch(e){error(e)}finally{return window.resolvefileSystask}}}};Task.Assigns(Setting),this.setting=function(arg){return Task.Assigns(arg)},this.permission=function(){},this.request=function(success,error){return OS.Ok===!1?f1(error,OS):Task.Request[OS.Base](function(e){return f1(success,e)},function(e){return"string"!=typeof e&&e.message&&(e=e.message),f1(error,e)})},this.resolve=function(file,success,error){return OS.Ok===!1?f1(error,OS):Task.Resolve[OS.Base](file,function(e){return f1(success,e)},function(e){return"string"!=typeof e&&e.message&&(e=e.message),f1(error,e)})},this.get=function(Obj){return Obj=Task.Arguments(Obj,arguments),new Promise(function(resolve,reject){fileRequest(Obj,function(fileRequestHas,o){if(1==fileRequestHas)Obj.fileOption.create===!0&&Obj.fileContent&&Obj.fileContentType?fileWriter(o,Obj,function(isFileWritten,fileWriterMsg){isFileWritten?resolve(Obj):reject(fileWriterMsg)}):fileReader(o,Obj,function(isFileRead,fileReaderMsg){Obj.fileContent=fileReaderMsg,isFileRead?resolve(Obj):reject(fileWriterMsg)});else if(2==fileRequestHas){var isBecauseDir=dirCheck(Obj.fileUrlLocal);isBecauseDir&&Obj.fileOption.create===!0&&Obj.fileContent&&Obj.fileContentType?dirCreator(o,isBecauseDir,function(isDirCreated,dirCreatorMsg){isDirCreated?fileCreator(o,Obj,function(isFileCreated,fileCreatorMsg){isFileCreated?resolve(Obj):reject(fileCreatorMsg)}):reject(dirCreatorMsg)}):reject(o)}else reject(o)})}).then(function(e){return Obj.success(e),e},function(e){return Obj.fail(e),e}).then(function(e){return Obj.done(e),e})},this.remove=function(Obj){return Obj=Task.Arguments(Obj,arguments),new Promise(function(resolve,reject){fileRequest(Obj,function(fileRequestHas,o){1==fileRequestHas?fileRemover(o,Obj,function(isFileRemoved,fileRemoverMsg){isFileRemoved?resolve(o):reject(fileRemoverMsg)}):2==fileRequestHas&&Obj.fileNotFound?resolve(o):reject(o)})}).then(function(e){return Obj.success(e),e},function(e){return Obj.fail(e),e}).then(function(e){return Obj.done(e),e})},this.download=function(Obj){return Obj=Task.Arguments(Obj,arguments),new Promise(function(resolve,reject){var xmlHttp=window.XMLHttpRequest?new XMLHttpRequest:new ActiveXObject("Microsoft.XMLHTTP"),Percentage=0;xmlHttp.addEventListener("progress",function(e){Percentage++,e.lengthComputable?(Percentage=Math.floor(e.loaded/e.total*100),Obj.progress(Percentage)):xmlHttp.readyState==XMLHttpRequest.DONE?Obj.progress(100):200!=xmlHttp.status&&(Obj.progress(Math.floor(Percentage/7*100)),Percentage++)},!1),xmlHttp.addEventListener("load",function(e){if(Obj.fileUrlResponse=e.target.responseURL,Obj.fileName=Obj.fileUrl.replace(/[\#\?].*$/,"").substring(Obj.fileUrl.lastIndexOf("/")+1),Obj.fileExtension=Obj.fileName.split(".").pop(),Obj.fileUrlLocal)if(Obj.fileUrlLocal===!0){var fileUrlLocalTmp=Obj.fileUrl.match(/\/\/[^\/]+\/([^\.]+)/);fileUrlLocalTmp?Obj.fileUrlLocal=fileUrlLocalTmp[1].replace(/[\#\?].*$/,""):Obj.fileUrlLocal=Obj.fileUrl.replace(/[\#\?].*$/,"")}else Obj.fileUrlLocal=Obj.fileUrlLocal.replace(/[\#\?].*$/,"");else Obj.fileUrlLocal=Obj.fileName;e.target.responseXML?(Obj.fileCharset=e.target.responseXML.charset,Obj.fileContentType=e.target.responseXML.contentType):(Obj.fileCharset="UTF-8",Task.extension[Obj.fileExtension]&&(Obj.fileContentType=Task.extension[Obj.fileExtension].ContentType)),Obj.responseXML=e.target.responseXML,Obj.responseURL=e.target.responseURL,200==xmlHttp.status?(Obj.fileSize=e.total,Obj.fileContent=e.target.responseText,"object"==typeof Obj.fileOption&&Obj.fileOption.create===!0&&Obj.fileUrlLocal&&OS.Ok===!0?fileRequest(Obj,function(fileRequestHas,o){if(1==fileRequestHas)fileWriter(o,Obj,function(isFileWritten,fileWriterMsg){isFileWritten?(Obj.fileCreation=!0,resolve(Obj)):(Obj.fileCreation=fileWriterMsg,reject(Obj))});else if(2==fileRequestHas){var isBecauseDir=dirCheck(Obj.fileUrlLocal);isBecauseDir?dirCreator(o,isBecauseDir,function(isDirCreated,dirCreatorMsg){isDirCreated?fileCreator(o,Obj,function(isFileCreated,fileCreatorMsg){isFileCreated?(Obj.fileCreation=!0,resolve(Obj)):(Obj.fileCreation=fileCreatorMsg,reject(Obj))}):(Obj.fileCreation=dirCreatorMsg,reject(Obj))}):(Obj.fileCreation=o,reject(Obj))}else Obj.fileCreation=o,reject(Obj)}):(Obj.fileCreation=!1,resolve(Obj))):reject(xmlHttp.statusText?{message:xmlHttp.statusText+": "+Obj.fileUrl,code:xmlHttp.status}:xmlHttp.status?{message:"Error",code:xmlHttp.status}:{message:"Unknown Error",code:0})},!1),xmlHttp.addEventListener("error",function(e){reject(e)},!1),xmlHttp.addEventListener("abort",function(e){reject(e)},!1),Obj.fileCache?Obj.fileUrlRequest=Obj.fileUrl+(Obj.fileUrl.indexOf("?")>0?"&":"?")+"_="+(new Date).getTime():Obj.fileUrlRequest=Obj.fileUrl,Obj.fileUrl?(xmlHttp.open(Obj.requestMethod?Obj.requestMethod:"GET",Obj.fileUrlRequest,!0),Obj.before(xmlHttp),xmlHttp.send()):reject({message:"fileUrl not provided",code:0})}).then(function(e){return Obj.success(e),e},function(e){return Obj.fail(e),e}).then(function(e){return Obj.done(e),e})},this.save=function(Obj){return Obj=Task.Arguments(Obj,arguments),new Promise(function(resolve,reject){fileRequest(Obj,function(fileRequestHas,o){if(1==fileRequestHas)fileWriter(o,Obj,function(isFileWritten,fileWriterMsg){isFileWritten?resolve(Obj):reject(fileWriterMsg)});else if(2==fileRequestHas){var isBecauseDir=dirCheck(Obj.fileUrlLocal);isBecauseDir?dirCreator(o,isBecauseDir,function(isDirCreated,dirCreatorMsg){isDirCreated?fileCreator(o,Obj,function(isFileCreated,fileCreatorMsg){isFileCreated?resolve(Obj):reject(fileCreatorMsg)}):reject(o)}):reject(o)}else reject(o)})}).then(function(e){return Obj.success(e),e},function(e){return Obj.fail(e),e}).then(function(e){return Obj.done(e),e})}}}("fileSystask");